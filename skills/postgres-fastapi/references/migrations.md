# Migration Workflow Reference

## Migration Discipline

### The Golden Rules

1. **Models are the source of truth** - Edit models first, generate migrations second
2. **Auto-generate only** - Never write migration DDL by hand
3. **One migration per feature** - Consolidate drafts before commit
4. **Test locally always** - Apply and verify before committing
5. **Commit together** - Model + migration + types in same commit

## Standard Workflow

### New Feature Development

```bash
# Step 1: Update models
# Edit db/models/*.py

# Step 2: Generate draft migration
alembic revision --autogenerate -m "add feature_name schema"

# Step 3: Review generated file
# Check db/alembic/versions/<new_file>.py
# Verify upgrade() and downgrade() are correct

# Step 4: Apply to local DB
alembic upgrade head

# Step 5: Verify schema
# Connect to psql and check: \d table_name

# Step 6: Test application
# Run tests, verify everything works

# Step 7: Commit all together
git add db/models/ db/alembic/versions/
git commit -m "feat: add feature_name schema"
```

### Iterative Development (Draft Migrations)

During active development, you may generate multiple drafts:

```bash
# Iteration 1
alembic revision --autogenerate -m "draft add users"
alembic upgrade head

# Make more model changes...

# Iteration 2
alembic revision --autogenerate -m "draft add user profile"
alembic upgrade head

# Ready to finalize? Consolidate!
```

### Consolidation Workflow

When you have multiple draft migrations for one feature:

```bash
# Step 1: Downgrade to before your drafts
alembic downgrade <base_revision>

# Step 2: Reset local DB
# This is safe - it's local only
dropdb myapp_local
createdb myapp_local

# Step 3: Delete draft migrations
rm db/alembic/versions/*_draft_*.py

# Step 4: Stamp the base revision
alembic stamp <base_revision>

# Step 5: Generate ONE clean migration
alembic revision --autogenerate -m "add complete feature schema"

# Step 6: Apply and verify
alembic upgrade head
```

## Migration Script Template

```python
"""[description]

Revision ID: [auto-generated]
Revises: [previous revision]
Create Date: [auto-generated]
"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision: str = '[auto-generated]'
down_revision: Union[str, None] = '[previous]'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic ###
    pass
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic ###
    pass
    # ### end Alembic commands ###
```

## Data Migrations

Keep data migrations separate from schema migrations:

```python
"""migrate user roles from string to enum

Revision ID: 002
Revises: 001
"""
from alembic import op
import sqlalchemy as sa

def upgrade() -> None:
    # Create enum type
    op.execute("CREATE TYPE user_role AS ENUM ('user', 'admin', 'moderator')")

    # Add new column
    op.add_column(
        'users',
        sa.Column('role_new', postgresql.ENUM('user', 'admin', 'moderator', name='user_role'))
    )

    # Migrate data
    op.execute("""
        UPDATE users
        SET role_new = role::user_role
    """)

    # Drop old column, rename new
    op.drop_column('users', 'role')
    op.alter_column('users', 'role_new', new_column_name='role')

def downgrade() -> None:
    # Add string column back
    op.add_column('users', sa.Column('role_old', sa.String(20)))

    # Migrate data back
    op.execute("UPDATE users SET role_old = role::text")

    # Drop enum column
    op.drop_column('users', 'role')
    op.alter_column('users', 'role_old', new_column_name='role')

    # Drop enum type
    op.execute("DROP TYPE user_role")
```

## Handling Enum Changes

Enums require special handling - do in separate migration:

```python
# Migration 1: Add new enum value
def upgrade() -> None:
    op.execute("ALTER TYPE user_role ADD VALUE 'super_admin'")

def downgrade() -> None:
    # PostgreSQL doesn't support removing enum values
    # You need to recreate the enum
    pass
```

## Common Alembic Commands

```bash
# Show current revision
alembic current

# Show history
alembic history --verbose

# Show pending migrations
alembic heads

# Generate migration
alembic revision --autogenerate -m "description"

# Apply all migrations
alembic upgrade head

# Apply specific migration
alembic upgrade <revision>

# Rollback one
alembic downgrade -1

# Rollback to specific
alembic downgrade <revision>

# Rollback all
alembic downgrade base

# Mark DB at specific revision (no actual migration)
alembic stamp <revision>
```

## Environment Safety

```bash
# Environment variables
LOCAL_DB=postgresql://localhost/myapp_local
STAGING_DB=postgresql://staging.db.com/myapp
PROD_DB=postgresql://prod.db.com/myapp

# Always verify environment before migrating
echo $DATABASE_URL

# Use read-only connection for staging/prod checks
psql $STAGING_DB -c "SELECT version()"
```

## Pre-Migration Checklist

Before applying migrations to staging/production:

- [ ] Migration reviewed by another developer
- [ ] Tested on local with production data snapshot
- [ ] Database backed up
- [ ] Maintenance window scheduled (if needed)
- [ ] Rollback plan documented
- [ ] Monitoring alerts configured
